{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Funnel+Display:wght@300..800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'golden-brown': {
                            '50': '#faf7f2',
                            '100': '#f4ecdb',
                            '200': '#e8d7b5',
                            '300': '#dabb85',
                            '400': '#cb9a5a',
                            '500': '#c08647',
                            '600': '#a86c3a',
                            '700': '#8a5432',
                            '800': '#714530',
                            '900': '#603b2b',
                            '950': '#351e17',
                        }
                    },
          fontFamily: {
            'sans': ['Funnel Display', 'sans-serif'],
            'display': ['Funnel Display', 'sans-serif'],
          }
                }
            }
        }
    </script>
    <style>
        .dropdown:hover .dropdown-menu {
            display: block;
        }

        .carousel-slide {
            transition: transform 0.5s ease;
        }

        .thumbnail.active {
            border-color: #c08647;
            transform: scale(1.05);
        }

        .card-hover-effect:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        
    .toast-message {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    </style>
</head>

<body class="bg-gray-50 font-sans">
    <!-- Sticky Navbar -->
    <nav class="sticky top-0 z-50 bg-white shadow-md">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <!-- App Name -->
            <div class="flex items-center space-x-2">
                <span class="hidden sm:inline text-2xl font-bold text-golden-brown-700">Maghettoni</span>
            </div>

            <!-- Nav Icons -->
            <div class="flex items-center space-x-6">
                <!-- Home Icon -->
                {% if user.is_authenticated %}

            {% if request.resolver_match.url_name == 'homepage' %}
                <!-- Show filter URL and icon on homepage -->
                <a href="{% url 'roomsort' %}" class="text-golden-brown-600 hover:text-golden-brown-800 transition-colors" title="filter">
                    <i class="fas fa-filter text-xl"></i>
                </a>
            {% else %}
                <!-- Show home URL and icon on all other pages -->
                <a href="{% url 'homepage' %}" class="text-golden-brown-600 hover:text-golden-brown-800 transition-colors">
                    <i class="fas fa-home text-xl"></i>
                </a>
            {% endif %}
                <div class="relative">
                    <a href="{% url 'cart' %}"
                        class="text-golden-brown-600 hover:text-golden-brown-800 transition-colors">
                        <i class="fas fa-shopping-cart text-xl"></i>
                    </a>
                    {% if has_pending_booking %}
                    <span class="absolute -top-1 -right-1 h-3 w-3 rounded-full bg-red-500"></span>
                    {% endif %}
                </div>

                <!-- Profile Dropdown -->
                <div class="dropdown relative">
                    <button class="flex items-center space-x-2 focus:outline-none">
                        <div
                            class="h-8 w-8 rounded-full bg-golden-brown-400 flex items-center justify-center text-white">
                            <i class="fas fa-user"></i>
                        </div>
                        <span class="text-golden-brown-700">Hi, {{ user.first_name }}</span>
                        <i class="fas fa-chevron-down text-xs text-golden-brown-600"></i>
                    </button>

          <!-- Dropdown Menu -->
          <div class="dropdown-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
            {% if user.is_staff %}
            <a href="{% url 'staff_dashboard' %}"
              class="block px-4 py-2 text-sm text-gray-700 hover:bg-golden-brown-100 flex items-center">
              <i class="fa-solid fa-list-check mr-2 text-golden-brown-600"></i> Staff
            </a>
            <a href="{% url 'actions' %}"
            class="block px-4 py-2 text-sm text-gray-700 hover:bg-golden-brown-100 flex items-center">
            <i class="fa-solid fa-chart-line mr-2 text-golden-brown-600"></i>
            Actions
          </a>
            {% endif %}
            <a href="{% url 'profile' %}"
              class="block px-4 py-2 text-sm text-gray-700 hover:bg-golden-brown-100 flex items-center">
              <i class="fas fa-user-circle mr-2 text-golden-brown-600"></i> Profile
            </a>
            <a href="{% url 'logout' %}"
              class="block px-4 py-2 text-sm text-gray-700 hover:bg-golden-brown-100 flex items-center">
              <i class="fas fa-sign-out-alt mr-2 text-golden-brown-600"></i> Logout
            </a>
            {% else %}

            <a href="{% url 'login' %}"
              class="block px-4 py-2 text-sm text-gray-700 hover:bg-golden-brown-100 flex items-center">
              <i class="fas fa-sign-in-alt mr-2 text-golden-brown-600"></i> Login
            </a>
            {% endif %}
          </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
  {% block content %}

{% endblock %}
    
    </main>

    <!-- Footer -->
    <footer class="bg-golden-brown-900 text-white mt-16">
        <div class="container mx-auto px-4 py-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <!-- Social Icons -->
                <div class="flex space-x-4 mb-4 md:mb-0">
                    <a href="#" class="text-white hover:text-golden-brown-300 transition-colors">
                        <i class="fab fa-tiktok text-xl"></i>
                    </a>
                    <a href="#" class="text-white hover:text-golden-brown-300 transition-colors">
                        <i class="fas fa-phone-alt text-xl"></i>
                    </a>
                    <a href="#" class="text-white hover:text-golden-brown-300 transition-colors">
                        <i class="fab fa-whatsapp text-xl"></i>
                    </a>
                    <a href="#" class="text-white hover:text-golden-brown-300 transition-colors">
                        <i class="fas fa-envelope text-xl"></i>
                    </a>
                    <a href="#" class="text-white hover:text-golden-brown-300 transition-colors">
                        <i class="fab fa-instagram text-xl"></i>
                    </a>
                </div>

                <!-- Copyright -->
                <div class="text-center md:text-right">
                    <p class="text-golden-brown-300">Â© 2025 Maghettoni</p>
                    <p class="text-golden-brown-400 text-sm">All Rights Reserved</p>
                    <p class="text-golden-brown-400 text-sm">Designed by GCL</p>
                </div>
            </div>
        </div>
    </footer>
    <!-- Toast Messages -->
    {% if messages %}
    <div class="fixed-toast-container fixed top-4 right-4 z-50 space-y-3 w-full max-w-xs">
      {% for message in messages %}
      <div class="toast-message bg-gray-50 text-base text-golden-brown-800 border border-gray-800 rounded-lg shadow-lg overflow-hidden">
        <div class="toast-content flex justify-between items-center p-4">
          <div class="toast-text text-golden-brown-800">{{ message }}</div>
          <button type="button" class="toast-close text-gray-400 hover:text-golden-brown-800" onclick="this.parentElement.parentElement.remove()"><i class="fa-solid fa-x bg-golden-brown-100 text-golden-brown-800 w-8 h-8 rounded-full flex items-center justify-center hover:bg-golden-brown-200 transition-colors"></i></button>
        </div>
        <div class="toast-progress h-1 bg-golden-brown w-full">
          <div class="progress-bar h-full bg-golden-brown-500"></div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <script>

        // Carousel functionality
        document.addEventListener('DOMContentLoaded', function () {
            const slides = document.querySelectorAll('.carousel-slide');
            const thumbnails = document.querySelectorAll('.thumbnail');
            let currentSlide = 0;

            // Show initial slide
            showSlide(currentSlide);

            // Thumbnail click event
            thumbnails.forEach(thumb => {
                thumb.addEventListener('click', function () {
                    const slideIndex = parseInt(this.getAttribute('data-index'));

                    // Update active thumbnail
                    thumbnails.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    // Show selected slide
                    showSlide(slideIndex);
                    currentSlide = slideIndex;
                });
            });

            function showSlide(index) {
                slides.forEach((slide, i) => {
                    if (i === index) {
                        slide.classList.remove('opacity-0');
                        slide.classList.add('opacity-100');
                    } else {
                        slide.classList.remove('opacity-100');
                        slide.classList.add('opacity-0');
                    }
                });
            }

            // Auto-rotate slides (optional)
            setInterval(() => {
                currentSlide = (currentSlide + 1) % slides.length;
                showSlide(currentSlide);

                // Update active thumbnail
                thumbnails.forEach(t => t.classList.remove('active'));
                thumbnails[currentSlide].classList.add('active');
            }, 5000);
        });
    </script>

    <!-- Scripts -->
<script src="{% static 'js/login.js' %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var carousel = document.querySelector("#roomCarousel{{ room.id }}");
        var thumbnails = document.querySelectorAll(".main-imagee");

        carousel.addEventListener("slid.bs.carousel", function (event) {
            // Remove active class from all thumbnails
            thumbnails.forEach(img => img.classList.remove("active"));

            // Add active class to the corresponding thumbnail
            thumbnails[event.to].classList.add("active");
        });

        // Click event to change carousel slide
        thumbnails.forEach((thumbnail, index) => {
            thumbnail.addEventListener("click", function () {
                var carouselInstance = new bootstrap.Carousel(carousel);
                carouselInstance.to(index);
            });
        });
    });
</script>
<script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3A-ldVjUJhoKeEnD5u0OCExQkOg3A9nU&callback=initMap{{ room.id }}">
    </script>

<script>
    function initMap{{ room.id }}() {
        // const origin = { lat: {{ request.user.uni.lat }}, lng: {{ request.user.uni.lng }} };
        const origin = { lat: {{ request.user.university.lat }}, lng: {{ request.user.university.lng }} };
        const destination = { lat: {{ room.lat }}, lng: {{ room.lng }} };

    const map = new google.maps.Map(document.getElementById("map{{ room.id }}"), {
        zoom: 20,
        center: origin,
    });

    const directionsService = new google.maps.DirectionsService();
    const directionsRenderer = new google.maps.DirectionsRenderer({ map: map });

    directionsService.route(
        {
            origin: origin,
            destination: destination,
            travelMode: google.maps.TravelMode.DRIVING,
        },
        (response, status) => {
            if (status === "OK") {
                directionsRenderer.setDirections(response);
            } else {
                console.error("Directions request failed due to " + status);
            }
        }
    );
    }
</script>

<script    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3A-ldVjUJhoKeEnD5u0OCExQkOg3A9nU&libraries=places"></script>


<script>

    const uniLat = {{ request.user.university.lat }};
    const uniLng = {{ request.user.university.lng }};
    const roomLat = {{ room.lat }};
    const roomLng = {{ room.lng }};

    const service = new google.maps.DistanceMatrixService();
    const origin = new google.maps.LatLng(uniLat, uniLng);
    const destiny = new google.maps.LatLng(roomLat, roomLng);


    function updateDistanceAndTime() {
        const service = new google.maps.DistanceMatrixService();
        const origin = new google.maps.LatLng(uniLat, uniLng);
        const destination = new google.maps.LatLng(roomLat, roomLng);

        ['WALKING', 'DRIVING'].forEach(mode => {
            service.getDistanceMatrix({
                origins: [origin],
                destinations: [destination],
                travelMode: google.maps.TravelMode[mode],
            }, (response, status) => {
                if (status === 'OK') {
                    const result = response.rows[0].elements[0];
                    const distanceText = result.distance.text;
                    const durationText = result.duration.text;

                    if (mode === 'WALKING') {
                        document.getElementById('duration-info').innerHTML =
                            `<strong>Walking:</strong> ${durationText} | <strong>Driving:</strong> ...`;
                    } else {
                        document.getElementById('duration-info').innerHTML =
                            document.getElementById('duration-info').innerHTML.replace('...', '')  // remove placeholder
                                .replace(/<strong>Driving:<\/strong> .*/, `<strong>Driving:</strong> ${durationText}`);
                    }

                    document.getElementById('distance-info').innerHTML =
                        `<strong>Distance to {{ user.university }}:</strong> ${distanceText}`;
                } else {
                    console.error('Distance Matrix failed: ', status);
                }
            });
        });
    }

    document.addEventListener("DOMContentLoaded", updateDistanceAndTime);
    updateDistanceAndTime();

    
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Parse room coordinates safely as floats
        const roomLat = parseFloat("{{ room.lat }}");
        const roomLng = parseFloat("{{ room.lng }}");
        const roomLocation = new google.maps.LatLng(roomLat, roomLng);

        const universities = [
            {% for uni in unis %}
            {
                name: "{{ uni.name|escapejs }}",
                lat: parseFloat("{{ uni.lat }}"),
                lng: parseFloat("{{ uni.lng }}")
            },
            {% endfor %}
        ];

        const origins = universities.map(u => new google.maps.LatLng(u.lat, u.lng));
        const service = new google.maps.DistanceMatrixService();

        service.getDistanceMatrix(
            {
                origins: origins,
                destinations: [roomLocation],
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
            },
            function (response, status) {
                console.log("DistanceMatrix response:", response, "Status:", status); // Debugging

                if (status !== 'OK') {
                    console.error("DistanceMatrix failed:", status);
                    return;
                }

                let minIndex = 0;
                let minDistance = response.rows[0].elements[0].distance.value;

                response.rows.forEach((row, i) => {
                    const dist = row.elements[0].distance.value;
                    if (dist < minDistance) {
                        minDistance = dist;
                        minIndex = i;
                    }
                });

                const nearestUniText = "Closest to " + universities[minIndex].name;
                const nearestUniEl = document.getElementById("nearest-uni");

                if (nearestUniEl) {
                    nearestUniEl.innerText = nearestUniText;
                } else {
                    console.warn("Element with ID 'nearest-uni' not found.");
                }
            }
        );
    });

        // Auto-dismiss messages after 10 seconds
        document.addEventListener("DOMContentLoaded", function () {
      setTimeout(function () {
        document.querySelectorAll('.toast-message').forEach(function (toast) {
          toast.remove();
        });
      }, 10000);

      // Animate progress bar
      document.querySelectorAll('.toast-progress .progress-bar').forEach(function (bar) {
        bar.style.transition = "width 10s linear";
        bar.style.width = "100%";
      });
    });
    
</script>
</body>

</html>